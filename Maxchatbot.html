<div id="maxchat" style="margin:10px auto; font-family:sans-serif; border:1px solid #ccc; border-radius:10px; overflow:hidden; display:flex; flex-direction:column; background:#fff;">    <style>        #maxchat .chat-box {            flex:1;            overflow-y:auto;            padding:10px;            background:#f0f2f5;            font-size:14px;        }        #maxchat .bubble {            max-width: 75%;            padding:10px 14px;            margin:8px 0;            border-radius:18px;            word-wrap: break-word;            line-height: 1.4;            display: inline-block;            clear: both;        }        #maxchat .left {            background:#e4e6eb;            float:right;            text-align:left;            border-bottom-left-radius: 4px;        }        #maxchat .right {            background:#0084ff;            color:white;            float:left;            text-align:left;            border-bottom-right-radius: 4px;        }        #maxchat form {            display:flex;            border-top:1px solid #ccc;            background:#fff;            padding:10px;            position: sticky;            bottom: 0;            z-index: 10;            box-shadow: 0 -2px 5px rgb(0 0 0 / 0.1);        }        #maxchat input[type="text"] {            flex:1;            padding:10px 15px;            font-size:16px;            border:1px solid #ccc;            border-radius:25px;            outline:none;            min-width: 0;        }        #maxchat button {            margin-left:10px;            padding:0 20px;            background:#4e54c8;            border:none;            border-radius:25px;            color:#fff;            font-weight:bold;            cursor:pointer;            white-space: nowrap;        }    </style>    <div class="chat-box" id="chat-box"></div>    <form id="chat-form" autocomplete="off">        <input type="text" id="msg-input" placeholder="Write here... " required />        <button type="submit">Send</button>    </form>    </div> 

    <script>
function escapeHtml(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

var chatBox = document.getElementById("chat-box");
var form = document.getElementById("chat-form");
var input = document.getElementById("msg-input");

form.addEventListener("submit", function(e) {
    e.preventDefault();
    var text = input.value.trim();
    if (!text) return;

    chatBox.innerHTML += '<div id="maxid" class="bubble left"><b>:my_name:</b><br>' + escapeHtml(text) + '</div>';
    input.value = "";

    var xhr = new XMLHttpRequest();
    // On appelle notre proxy sur notre serveur
    var url = '/proxy-api?q=' + encodeURIComponent(text) + '&name=:my_name:';
    xhr.open("GET", url);

    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);
                var reply = data.reply || "Pas de réponse.";
                chatBox.innerHTML += '<div class="bubble right"><b>MaxChat</b><br>' + escapeHtml(reply) + '</div>';
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch(e) {
                chatBox.innerHTML += '<div class="bubble right">Erreur lecture JSON.</div>';
            }
        } else {
            chatBox.innerHTML += '<div class="bubble right">Erreur API: ' + xhr.status + '</div>';
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    xhr.onerror = function() {
        chatBox.innerHTML += '<div class="bubble right"><b>MaxChat</b><br>Erreur réseau — essayez plus tard.</div>';
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    xhr.send();
});
</script>