<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Robot MaxGram ‚Äî auto login Thibaut</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:18px;max-width:900px;}
  #log{height:160px;border:1px solid #ccc;padding:8px;overflow:auto;background:#fafafa;margin-bottom:12px;}
  iframe{width:100%;height:520px;border:1px solid #888;margin-top:12px;}
  pre{background:#eee;padding:8px;white-space:pre-wrap;}
  .ok{color:#0a8}
  .err{color:#c33}
  button{padding:8px 12px;margin-right:8px}
</style>
</head>
<body>

<h2>Robot MaxGram ‚Äî auto login (Thibaut)</h2>

<div id="log"></div>

<div>
  <button id="showScriptBtn">Afficher script (coller dans la console de l'iframe)</button>
  <button id="forceStartBtn">Relancer login / navigation (forcer)</button>
</div>

<!-- formulaire cach√© qui POSTe dans l'iframe -->
<form id="loginForm" action="//maxgram.wapaxo.com/site_login.html" method="post" target="robotFrame" style="display:none;">
  <!-- Username et mot de passe PR√â‚ÄëD√âFINIS -->
  <input name="user_name_" id="f_user" type="hidden" value="Thibaut">
  <input name="password_" id="f_pass" type="hidden" value="64932261">
  <input type="submit" name="login_user" id="f_submit" value="login">
</form>

<iframe id="robotFrame" name="robotFrame" src="about:blank"></iframe>

<details style="margin-top:12px;">
  <summary>Script √† coller dans la console de l'iframe (en mode page de cr√©ation)</summary>
  <pre id="consoleScript"></pre>
</details>

<script>
/* ==== CONFIG FIXE ==== */
const BASE_SITE = 'https://maxgram.wapaxo.com/page-bot-login.html';               // sans ?u=...&p=...
const CREATE_PAGE = BASE_SITE + '/page-bot-post.html';
const WAIT_AFTER_LOGIN_MS = 2200;   // attente apr√®s POST login
const WAIT_AFTER_NAV_MS = 1600;     // attente apr√®s navigation
const POSTS = [
  { text: "Post automatique n¬∞1 üöÄ", image: "" },
  { text: "Post automatique n¬∞2 üñºÔ∏è", image: "https://via.placeholder.com/300" },
  { text: "Post automatique n¬∞3 üéØ", image: "" }
];
/* ===================== */

const logEl = document.getElementById('log');
function log(msg, cls){
  const d = document.createElement('div');
  if(cls) d.className = cls;
  d.textContent = (new Date()).toLocaleTimeString() + ' ‚Äî ' + msg;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}

// pr√©parer le script √† coller dans la console de l'iframe (page de cr√©ation)
function makeConsoleScript(posts, delay=3000){
  return `(function(){
  const posts = ${JSON.stringify(posts, null, 2)};
  const delay = ${delay};
  async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function run(){
    console.log('‚ñ∂ Script Auto‚ÄëPost : d√©marrage');
    const textarea = document.querySelector('textarea[name="text"]') || document.querySelector('textarea');
    const imgInput = document.querySelector('input[name="var-img"]') || document.querySelector('input[type="text"]');
    const submitBtn = document.querySelector('button[name="blog_submit"]') || document.querySelector('button[type="submit"]') || document.querySelector('input[type="submit"]');
    if(!textarea || !submitBtn){
      console.error('‚ùå Formulaire introuvable. V√©rifie la page de cr√©ation et adapte les selecteurs.');
      return;
    }
    for(let i=0;i<posts.length;i++){
      const p = posts[i];
      console.log('‚Üí Publication ' + (i+1) + '/' + posts.length + ':', p.text);
      textarea.value = p.text;
      textarea.dispatchEvent(new Event('input',{bubbles:true}));
      if(imgInput){
        imgInput.value = p.image || '';
        imgInput.dispatchEvent(new Event('input',{bubbles:true}));
      }
      submitBtn.click();
      console.log('Click submit envoy√©');
      await sleep(delay);
    }
    console.log('‚úÖ Tous les posts envoy√©s.');
  }
  run();
})();`;
}

document.getElementById('consoleScript').textContent = makeConsoleScript(POSTS, 3000);

// actions principales
const loginForm = document.getElementById('loginForm');
const fUser = document.getElementById('f_user');
const fPass = document.getElementById('f_pass');
const frame = document.getElementById('robotFrame');

// Auto-login + navigation sequence
function autoLoginAndNavigate(){
  log('Soumission automatique du formulaire de login (Thibaut) dans l\'iframe‚Ä¶');
  try{
    loginForm.submit();
  }catch(e){
    log('Erreur lors de submit du formulaire : ' + e, 'err');
    return;
  }

  // Apr√®s POST, forcer l'iframe vers la base (sans query) puis vers la page de cr√©ation
  setTimeout(()=>{
    frame.src = BASE_SITE;
    log('Iframe navigue vers la page principale (sans params).');
    setTimeout(()=>{
      frame.src = CREATE_PAGE;
      log('Iframe navigue vers la page de cr√©ation : ' + CREATE_PAGE);
      log('üëâ Ouvre la console de l\'iframe (F12 ‚Üí s√©lection du frame) et colle le script dans <details> pour lancer les posts.');
    }, WAIT_AFTER_NAV_MS);
  }, WAIT_AFTER_LOGIN_MS);
}

// bouton pour forcer relance manuelle
document.getElementById('forceStartBtn').addEventListener('click', () => {
  autoLoginAndNavigate();
  log('Relance forc√©e demand√©e.');
});

// montrer le script pour copier/coller
document.getElementById('showScriptBtn').addEventListener('click', () => {
  const s = document.getElementById('consoleScript').textContent;
  log('Script de publication pr√™t (copie depuis le panneau ci‚Äëdessous).', 'ok');
  console.log(s);
});

// Auto-run : lancer automatiquement au chargement de la page parente
window.addEventListener('load', () => {
  // Lancement automatique imm√©diat
  setTimeout(() => {
    autoLoginAndNavigate();
  }, 300);
});
</script>

</body>
</html>