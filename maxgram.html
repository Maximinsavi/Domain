<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Robot Multi‚ÄëMaxGram ‚Äî sans ?u=&p=</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:16px;max-width:1100px;}
  textarea,input,button{font-size:14px;}
  textarea#profiles{width:100%;height:140px;}
  #log{height:200px;border:1px solid #ccc;padding:8px;overflow:auto;background:#fafafa;margin-top:8px;}
  iframe{width:100%;height:520px;border:1px solid #888;margin-top:12px;}
  .row{display:flex;gap:8px;margin-top:8px;}
  .small{width:160px;}
  .ok{color:#0a8}
  .err{color:#c33}
  pre{background:#eee;padding:8px;white-space:pre-wrap;}
</style>
</head>
<body>
  <h2>Robot Multi‚ÄëMaxGram ‚Äî Login iframe (sans query params)</h2>

  <p>
    Entrez la liste de profils (un par ligne), format : <code>username|p</code><br>
    Exemple : <code>Thibaut|64932261</code>
  </p>

  <textarea id="profiles" placeholder="Thibaut|64932261
maximin|64932261"></textarea>

  <div style="margin-top:8px;">
    <label>Mot de passe utilis√© pour tous les comptes (remplace ici) :</label><br>
    <input id="sharedPwd" type="password" placeholder="motdepasse partag√©" style="width:320px" />
    <button id="savePwd">Enregistrer</button>
  </div>

  <div class="row">
    <button id="startAll">Lancer tout (login + open create pour chaque profil)</button>
    <button id="stopAll" disabled>Arr√™ter</button>
    <button id="generateAllScripts">G√©n√©rer/Pr√©parer tous les scripts (copiable)</button>
  </div>

  <div id="log"></div>

  <!-- hidden form target iframe -->
  <form id="loginForm" action="//maxgram.wapaxo.com/site_login.html" method="post" target="robotFrame" style="display:none;">
    <input name="user_name_" id="f_user" type="hidden" value="Thibaut">
    <input name="password_" id="f_pass" type="hidden" value="64932261">
    <input type="submit" name="login_user" id="f_submit" value="login">
  </form>

  <h3>Iframe MaxGram (visual)</h3>
  <iframe id="robotFrame" name="robotFrame" src="about:blank"></iframe>

  <details style="margin-top:12px;">
    <summary>Script d'exemple (√† coller dans la console de l'iframe pour envoyer les posts)</summary>
    <pre id="sampleScript"></pre>
  </details>

<script>
/* ===== CONFIG ===== */
const BASE_SITE = 'https://maxgram.wapaxo.com';               // <--- sans ?u=...&p=...
const CREATE_PAGE = BASE_SITE + '/page-bot-post.html';
const WAIT_AFTER_POST_LOGIN_MS = 3000; // attente apr√®s login POST
const WAIT_AFTER_NAV_MS = 2500; // attente apr√®s navigation vers profile/create
const POSTS = [
  { text: "Post auto 1 üöÄ", image: "" },
  { text: "Post auto 2 üñºÔ∏è", image: "https://via.placeholder.com/300" }
];
/* ================== */

const profilesEl = document.getElementById('profiles');
const logEl = document.getElementById('log');
const frame = document.getElementById('robotFrame');
const fUser = document.getElementById('f_user');
const fPass = document.getElementById('f_pass');
const fSubmit = document.getElementById('f_submit');
const loginForm = document.getElementById('loginForm');

let stopRequested = false;
let storedPwd = '';

function appendLog(txt, cls){
  const d = document.createElement('div');
  if(cls) d.className = cls;
  d.textContent = (new Date()).toLocaleTimeString() + ' ‚Äî ' + txt;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
  console.log(txt);
}

document.getElementById('savePwd').addEventListener('click', () => {
  storedPwd = document.getElementById('sharedPwd').value || '';
  if(!storedPwd) {
    appendLog('‚ö†Ô∏è Mot de passe vide ‚Äî entre le mot de passe partag√©.', 'err');
  } else {
    appendLog('Mot de passe enregistr√© (en m√©moire du navigateur).', 'ok');
  }
});

// parse profiles textarea into array of {u,p}
function parseProfiles(){
  const lines = profilesEl.value.split('\n').map(l => l.trim()).filter(Boolean);
  const arr = [];
  for(const ln of lines){
    const parts = ln.split('|').map(s=>s.trim());
    if(parts.length < 2){
      appendLog('Ligne ignor√©e (format invalide): ' + ln, 'err');
      continue;
    }
    arr.push({ u: parts[0], p: parts[1] });
  }
  return arr;
}

// generate per-profile console-script to paste in iframe
function makeConsoleScriptForProfile(profile, posts=POSTS, delay=3000){
  const postsStr = JSON.stringify(posts, null, 2);
  // script uses base site content (no reliance on ?u=...&p=...), works on creation page
  return `(function(){
  const posts = ${postsStr};
  const delay = ${delay};
  async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function run(){
    console.log('‚ñ∂ Script Auto-Post ‚Äî d√©marrage');
    const textarea = document.querySelector('textarea[name="text"]') || document.querySelector('textarea');
    const imgInput = document.querySelector('input[name="var-img"]') || document.querySelector('input[type="text"]');
    const submitBtn = document.querySelector('button[name="blog_submit"]') || document.querySelector('button[type="submit"]') || document.querySelector('input[type="submit"]');
    if(!textarea || !submitBtn){
      console.error('‚ùå Formulaire introuvable sur la page de cr√©ation. V√©rifie les s√©lecteurs.');
      return;
    }
    for(let i=0;i<posts.length;i++){
      const p = posts[i];
      console.log('‚Üí Publication ' + (i+1) + '/' + posts.length + ':', p.text);
      textarea.value = p.text;
      textarea.dispatchEvent(new Event('input',{bubbles:true}));
      if(imgInput){
        imgInput.value = p.image || '';
        imgInput.dispatchEvent(new Event('input',{bubbles:true}));
      }
      submitBtn.click();
      console.log('Click submit envoy√©');
      await sleep(delay);
    }
    console.log('‚úÖ Tous les posts envoy√©s pour ${profile.u}');
  }
  run();
})();`;
}

// show sample script area
function showSampleScript(text){
  document.getElementById('sampleScript').textContent = text;
}

// START processing all profiles sequentially: login -> open base site -> open create page
document.getElementById('startAll').addEventListener('click', async ()=>{
  stopRequested = false;
  const list = parseProfiles();
  if(list.length === 0){
    appendLog('Aucun profil trouv√©. Ajoute des lignes "user|p" dans la zone.', 'err');
    return;
  }
  if(!storedPwd){
    appendLog('‚ö†Ô∏è Mot de passe partag√© non d√©fini. Clique "Enregistrer" apr√®s saisie.', 'err');
    return;
  }
  document.getElementById('startAll').disabled = true;
  document.getElementById('stopAll').disabled = false;
  appendLog('D√©marrage du traitement pour ' + list.length + ' profil(s) ...');

  for(let i=0;i<list.length && !stopRequested;i++){
    const prof = list[i];
    appendLog(`--- Traitement (${i+1}/${list.length}): ${prof.u} | p=${prof.p} ---`);
    // set login form values (use storedPwd)
    fUser.value = prof.u;
    fPass.value = storedPwd;

    // submit form to iframe (POST to site_login.html in iframe)
    try{
      loginForm.submit();
      appendLog('Formulaire de login soumis dans l\'iframe pour ' + prof.u);
    } catch(e){
      appendLog('Erreur lors de la soumission du formulaire: ' + e, 'err');
      continue;
    }

    // after small wait, navigate iframe to the base site (no ?u=...&p=)
    await new Promise(r => setTimeout(r, WAIT_AFTER_POST_LOGIN_MS));
    const baseUrl = BASE_SITE; // no query params
    frame.src = baseUrl;
    appendLog('Iframe navigue vers ' + baseUrl);

    // wait for base site load (we cannot read DOM cross-origin reliably, so wait fixed ms)
    await new Promise(r => setTimeout(r, WAIT_AFTER_NAV_MS));

    // navigate to create page
    appendLog('Ouverture de la page de cr√©ation pour ' + prof.u);
    frame.src = CREATE_PAGE;
    await new Promise(r => setTimeout(r, WAIT_AFTER_NAV_MS));

    // generate console script for this profile and display it for copy
    const cs = makeConsoleScriptForProfile(prof, POSTS, 3000);
    showSampleScript(cs);
    appendLog('Script pour poster g√©n√©r√© pour ' + prof.u + '. Copie-le et colle-le dans la console de l\'iframe pour lancer les publications.');
    appendLog('--- Fin du profil ' + prof.u + ' ---');

    // small pause before next profile
    await new Promise(r => setTimeout(r, 1200));
  }

  appendLog('Traitement termin√©.');
  document.getElementById('startAll').disabled = false;
  document.getElementById('stopAll').disabled = true;
});

// stop
document.getElementById('stopAll').addEventListener('click', ()=>{
  stopRequested = true;
  appendLog('Arr√™t demand√© par l\'utilisateur.');
  document.getElementById('startAll').disabled = false;
  document.getElementById('stopAll').disabled = true;
});

// generate scripts for all profiles at once into sampleScript
document.getElementById('generateAllScripts').addEventListener('click', ()=>{
  const list = parseProfiles();
  if(list.length === 0){ appendLog('Aucun profil trouv√© pour g√©n√©rer', 'err'); return; }
  const all = list.map(p => `/* Script pour ${p.u} */\n${makeConsoleScriptForProfile(p)}\n\n`).join('\n');
  showSampleScript(all);
  appendLog('Scripts g√©n√©r√©s pour ' + list.length + ' profil(s). Copie celui que tu veux et colle dans la console de l\'iframe.');
});

// initialize sample script area with first profile example
(function init(){
  const first = parseProfiles()[0] || {u:'example', p:'64932261'};
  showSampleScript(makeConsoleScriptForProfile(first));
  appendLog('Pr√™t ‚Äî renseigne les profils, le mot de passe partag√©, puis clique "Lancer tout".');
})();
</script>
</body>
</html>